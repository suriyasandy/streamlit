# Step 1: Group and count trades
grouped = (
    result_df
    .groupby(['reasoncodeid', 'Date', 'HighLevelCode'])
    .size()
    .reset_index(name='count')
)

# Step 2: Pivot with multi-level columns (Date â†’ HighLevelCode)
pivot_df = grouped.pivot_table(
    index='reasoncodeid',
    columns=['Date', 'HighLevelCode'],
    values='count',
    fill_value=0
)

# Step 3: Optional - reset index for AgGrid display
pivot_df = pivot_df.reset_index()

from st_aggrid import AgGrid

AgGrid(pivot_df, fit_columns_on_grid_load=True)
# Flatten the multi-index columns for visual clarity
pivot_df.columns = [
    f"{date} | {hlc}" if hlc != "" else f"{date}"
    for date, hlc in pivot_df.columns
]
with pd.ExcelWriter("output.xlsx", engine="xlsxwriter") as writer:
    pivot_df.set_index('reasoncodeid').to_excel(writer, sheet_name="ThemeSummary")
