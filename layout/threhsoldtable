import streamlit as st
import pandas as pd
from st_aggrid import AgGrid, GridOptionsBuilder, GridUpdateMode

st.set_page_config(layout="wide")

st.title("üìä Group-wise Threshold Recalibration")

# Step 1: File Upload
uploaded_file = st.file_uploader("Upload Threshold File (.csv)", type=["csv"])

if uploaded_file:
    df = pd.read_csv(uploaded_file)

    # Step 2: Group-wise Aggregation
    group_df = df.groupby("Proposed_Group").agg({
        "Existing_Threshold": "mean",
        "Proposed_Threshold": "mean"
    }).reset_index()

    group_df.rename(columns={
        "Proposed_Group": "Group",
        "Existing_Threshold": "Existing Threshold",
        "Proposed_Threshold": "Proposed Threshold"
    }, inplace=True)

    # Step 3: Add Final Threshold (default = Proposed)
    group_df["Final Threshold"] = group_df["Proposed Threshold"]

    # Initialize in session state if not already
    if "group_thresholds" not in st.session_state:
        st.session_state.group_thresholds = group_df.copy()

    st.subheader("üìù Edit Final Thresholds per Group")

    # Step 4: AGGrid Setup
    gb = GridOptionsBuilder.from_dataframe(st.session_state.group_thresholds)
    gb.configure_column("Final Threshold", editable=True)
    gb.configure_column("Group", editable=False)
    gb.configure_column("Existing Threshold", editable=False)
    gb.configure_column("Proposed Threshold", editable=False)
    grid_options = gb.build()

    grid_response = AgGrid(
        st.session_state.group_thresholds,
        gridOptions=grid_options,
        update_mode=GridUpdateMode.VALUE_CHANGED,
        fit_columns_on_grid_load=True,
        height=300,
        use_container_width=True,
        key="group_aggrid"
    )

    # Step 5: Update session state with edited data
    st.session_state.group_thresholds = grid_response["data"]

    st.success("‚úÖ Edits captured. You can now use the final thresholds for alert impact analysis.")

    # Optional display
    if st.checkbox("Show Final Threshold Table"):
        st.dataframe(st.session_state.group_thresholds)
